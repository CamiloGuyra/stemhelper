---
output: github_document
always_allow_html: yes
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-",
  warning = FALSE, 
  message = FALSE,
  fig.width=4,
  fig.height=6,
  fig.align = "center"
)
devtools::load_all()
```

# stemhelper: Helper functions for STEM loading, mapping, plotting, and analysis

<!-- [![License: GPL v3](https://img.shields.io/badge/License-GPL%20v3-blue.svg)](http://www.gnu.org/licenses/gpl-3.0) -->

**THIS PACKAGE IS UNDER ACTIVE DEVELOPMENT. FUNCTIONALITY MAY CHANGE AT ANY TIME.**

The goal of stemhelper is to provide functionality for loading, mapping, plotting, and analyzing STEM results.

## Installation

You can install stemhelper from GitHub with:

```{r gh-installation, eval = FALSE}
# install the development version from GitHub
# install.packages("devtools")
devtools::install_github("CornellLabofOrnithology/stemhelper")
```

## Vignette

For a full introduction and advanced usage, please see the package [website](https://cornelllabofornithology.github.io/stemhelper). An [introductory vignette](https://cornelllabofornithology.github.io/stemhelper/articles/stem-intro-mapping.html) is available, detailing the structure of the results and how to begin loading and mapping the results. Further, an [advanced vignette](ttps://cornelllabofornithology.github.io/stemhelper/articles/stem-pipd.html) details how to access additional information from the model results about predictor importance and directionality, as well as predictive performance metrics.

## Quick Start

After downloading results...

One of the first things to do is to load a RasterStack of estimated abundance predictions and plot a week of estimates.

```{r quick_start}
library(viridis)
library(mapview)
library(raster)

# TODO set this up to do a curl of the example results first

# SETUP PATHS
# Note, if you currently access results you can use this path construction
# by replacing the root_path with where your copy lives
root_path <- "~/Box Sync/Projects/2015_stem_hwf/documentation/data-raw/"
species <- "woothr-ERD2016-PROD-20170505-3f880822"
sp_path <- paste(root_path, species, sep = "")

# load a stack of rasters with the helper function stack_stem()
abund <- stack_stem(sp_path, variable = "abundance_umean")

# project to Mollweide for mapping and extent calc, this takes awhile
mollweide <- CRS("+proj=moll +lon_0=-90 +x_0=0 +y_0=0 +ellps=WGS84")
abund_stack <- projectRaster(abund, crs = mollweide)

# calculate the full annual extent on the abundance stack (in sinusoidal projection)
sp_ext <- calc_full_extent(abund_stack)

# calculate ideal color bins for abundance values across the full year
year_bins <- calc_bins(abund_stack)

# the helper function combine_layers() fills in with assumed and predicted zeroes
week26 <- combine_layers(abund_stack, sp_path, week = 26)

# do a quick visualization with the mapview package
mapviewOptions(legend = TRUE)
mapView(week26, 
        col.regions = viridis(length(year_bins)-1), 
        at = year_bins,
        maxpixels = ncell(week26))
```
